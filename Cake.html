<html>
  <body>
    <script>
async function getCake() {
    var cake;
    try {
       var devices = await navigator.bluetooth.getDevices();
       cake = devices.find(d => d.name == 'cake');
    }
    catch (e) {
       console.log(e);
    }
    if (cake == undefined) {
       cake = await navigator.bluetooth.requestDevice({filters: [{namePrefix: 'cake'}], optionalServices: ['a64a814d-8015-4e79-a6a1-163747a56170']});
    }

    connect = async function() {
        if (!cake.gatt.connected) {
            svr = await cake.gatt.connect();
            svc = await svr.getPrimaryService('a64a814d-8015-4e79-a6a1-163747a56170');
        }
    }

    return {
        fetch: async function() {
            var decoder = new TextDecoder('utf-8');
            await connect();
            var c = await svc.getCharacteristic('1df15fee-4124-44a2-9c77-8bce929b3e71');
            var v = await c.readValue();
            return decoder.decode(v);
        },

        update: async function(v) {
            var encoder = new TextEncoder('utf-8');
            await connect();
            var c = await svc.getCharacteristic('1df15fee-4124-44a2-9c77-8bce929b3e71');
            await c.writeValue(encoder.encode(v));
        },

        close: async function() {
           if (cake.gatt.connected) {
               await cake.gatt.disconnect();
           }
        }
    };
}    

var cake = undefined;

async function disconnect() {
  if (cake != undefined) {
    cake.close();
    result.innerText = "";
  }
}

async function fetch() {
  try {
    if (cake == undefined) {
      cake = await getCake();
    }
    var v = await cake.fetch();
    await c.close();
    result.innerText = v;
  }
  catch (e) {
    result.innerText = e.message;
  }
}

async function send(v) {
  try {
    if (cake == undefined) {
      cake = await getCake();
    }
    await cake.update(v);
    await fetch();
  }
  catch (e) {
    result.innerText = e.message;
  }
}

    </script>
    <p><button onclick="fetch()">Fetch</button><span id="result"/></p>
    <p><button onclick="send(command.value)">Send</button><input id="command" type="text"/></p>
    <p><button onclick="send('faster')">Faster</button></p>
    <p><button onclick="send('slower')">Slower</button></p>
    <p><button onclick="send('rate:' + speed.value)">Speed</button><input id="speed" type="number"/></p>
    <p><button onclick="send('tune:' + tune.value)">Song</button><input id="tune" type="number"/></p>
    <p><button onclick="disconnect()">Logout</button></p>
  </body>
</html>
